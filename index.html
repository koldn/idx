<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Lucene Shinenigans</title>

    <meta name="description" content="Lucene Shinenigans">
    <meta name="author" content="Dmitriy Kolmogortsev">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/white.css" id="theme">

    <link rel="stylesheet" href="css/hljs/idea.css" id="highlight-theme">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->

    <style>
        .reveal .slide-number {
            font-size: 22pt;
            color: black;
        }
        
        .reveal pre {
            background: none;
            border: none;
            box-shadow: none;
        }
        
        .reveal pre code {
            color: black;
            background: none;
            box-shadow: none;
            max-height: none;
        }
        /* .reveal section img {
            border: none;
            box-shadow: none;
        }*/
        
        .reveal pre code {
            overflow: hidden;
        }
        
        .reveal .footer {
            font-size: 22pt;
            position: absolute;
            left: 35%;
            bottom: 0.5em;
        }
        
        .corp-name {
            color: orangered;
            font-family: "Circe", sans-serif;
            ;
        }
        
        .red-text {
            color: red;
        }
        
        .reveal table {
            font-size: 75%;
        }
        
        .reveal table td {
            vertical-align: middle;
            border-bottom: none;
            word-break: keep-all;
            word-wrap: break-word;
        }
    </style>
</head>

<body>

    <div class="reveal">
        <div class="footer">
            <span class="corp-name"><b>NAUMEN</b></span> Колмогорцев Дмитрий
        </div>
        <!-- Any section element inside of this container is displayed as a slide -->
        <div class="slides">
            <section>
                <h2>Спасти поиск в приложении и не сойти с ума</h2>
                <p>
                    <small>
                        Колмогорцев Дмитрий / <a href="mailto:dkolmogortsev@naumen.ru">dkolmogortsev@naumen.ru</a>
                        <br/>
                        <br/>
                        </small>
                </p>
            </section>
            <section>
                <h2>Safe Harbor</h2>
                <p class="red-text">User experience may vary</p>
            </section>
            <section>
                <h2>О чем поговорим</h2>
                <ul>
                    <li>Как все работало до всего того, о чем я расскажу</li>
                    <li>Как одна маленькая задача привела к множеству изменений</li>
                    <li>Как ускорили и как с этим дальше жить</li>
                </ul>
            </section>
            <section data-background="img/lucene.png" data-background-size="55%" data-background-transition="zoom"></section>
            <section>
                <h4>Lucene Inside</h4>
                <table>
                    <tbody>
                        <tr>
                            <td><img src="img/solr.png" / style="border: none"></td>
                            <td><img src="img/elastic.png" style="border: none" /></td>
                            <td><img src="img/cratedb.jpg" style="border: none" /></td>
                        </tr>
                    </tbody>
                </table>
            </section>
            <section>
                <p>Но ведь есть ${productName}!! Зачем оно вам?!</p>
                <p class="fragment">Поиск - <span class="red-text"><b>business critical</b></span> фича для нас, мы должны мочь контролировать всё <span class="red-text"><b>сами</b></span></p>
            </section>
            <section>
                <h3>Зачем</h3>
                <img src="img/scwf.png" style="border: none"/>
            </section>
            <section>
                <h4>Что индексируем?</h4>
                <p class="fragment">Всё <span class="fragment">( при желании )</span></p>
                <p class="fragment">Атрибуты объектов системы</p>
                <p class="fragment">Файлы, связанные с объектами</p>
            </section>
            <section data-background="img/indexation-jms.png" data-background-size="35%" data-background-transition="zoom"></section>
            <section data-background="img/unicorn.gif" data-background-transition="zoom"></section>
            <section>
                <h2>Проблема: бесконечая переиндексация</h2>
                <pre>
                            <code data-trim data-noescape class="java">
                                //1 hour tx timeout
                                onMessage(Message msg) {
                                    try {
                                        //doIndexation
                                    }
                                    catch(Exception e) {
                                        //e instanceof ObjectNotFoundException
                                        //e instanceof LockObtainFailedException
                                        jmsTemplate.send(destination, msg)
                                    }
                                }
                            </code>
                        </pre>
            </section>
            <section>
                <div>
                    <p>
                        Очередь индексации будет постоянно расти, и ничего проиндексировано не будет
                    </p>
                </div>
                <div class="fragment">
                    <p>
                        <b>Решение</b><br> Ограничить кол-во попыток индексации
                    </p>
                </div>
            </section>
            <section>
                <h2>Решение:</h2>
                <pre>
                            <code data-trim data-noescape class="java">
                                onMessage(Message msg) {
                                    tryToIndex()
                                    Collection dlqIds = collectDqlIds()
                                    
                                    if(!dlqIds.isEmpty()) {
                                        //send to Dead Letter Queue
                                    }                                                                        
                                }
                            </code>
                        </pre>
            </section>
            <section>
                <div>
                    Прекрасно работающее решение, открывающее новые...<span class="fragment"> проблемы с файлами</span>
                </div>
            </section>

            <section>
                <h4>Индексация файла ушла в себя</h4>
                <pre>
                            <code data-trim data-noescape class="java" style="width: 150%">
                                    "Thread-15" #335 daemon prio=5 os_prio=0....
                                    java.lang.Thread.State: RUNNABLE
                                        at org.apache.tika.sax.ContentHandlerDecorator.ignorableWhitespace
                                        ...
                                        at org.apache.tika.Tika.parseToString(Tika.java:496)
                                        at org.apache.tika.Tika.parseToString(Tika.java:571)
                                        at ExtractFileContentsFunction.apply(...)
                                        at ExtractFileContentsFunction.apply(...)
                                        at com.google.common.collect.Iterators$8.transform(...)
                                        at com.google.common.collect.TransformedIterator.next(...)
                                        at StringUtilities.join(StringUtilities.java:600)
                                        at StringUtilities.join(StringUtilities.java:572)
                                        at StringUtilities.join(StringUtilities.java:540)
                                        at LuceneDocumentBuilder.addExtendedField(...)
                                        at LuceneDocumentBuilder.addExtendedFields(...)
                                        at LuceneDocumentBuilder.buildDocument(...)
                                        ...
                            </code>
                        </pre>
            </section>

            <section>
                <div>
                    <p>
                        <b>Проблема:</b><br> Поток индексации один, транзакция для одного объекта коротка, чтение содержимого занимает время куда большее чем таймаут транзакции
                    </p>
                </div>
                <div class="fragment">
                    <p>
                        <b>Решение:</b><br> Индексировать файлы отдельно от всего остального
                    </p>
                </div>
            </section>
            <section>
                <h3>Файл не получится индексировать</h3>
                <pre>
                        <code data-trim data-noescape class="java" style="width: 150%">
    java.lang.NoSuchMethodError: XMLSlideShow.getSlides()
        at o.a.t.p.m.ooxml.XSLFPowerPointExtractorDecorator.buildXHTML(...)
        at o.a.t.p.m.ooxml.AbstractOOXMLExtractor.getXHTML(...)
        at o.a.t.p.m.ooxml.OOXMLExtractorFactory.parse(...)
        at o.a.t.p.microsoft.ooxml.OOXMLParser.parse(...)
        at o.a.t.p.CompositeParser.parse(CompositeParser.java:256)
        at o.a.t.p.CompositeParser.parse(CompositeParser.java:256)
        at o.a.t.p.AutoDetectParser.parse(AutoDetectParser.java:120)
                        </code>
                    </pre>
                <div>
                    o.a.t.p - org.apache.tika.parser
                </div>
            </section>
            <section data-background="img/unicorn.gif" data-background-transition="zoom"></section>

            <section>
                <h3> Lucene deep dive </h3>
            </section>
            <section>
                <p>Основы:</p>
                <ul>
                    <li>Document</li>
                    <li>IndexWriter</li>
                    <li>Directory</li>
                </ul>

            </section>
            <section>
                <h4>Document</h4>
                <ul>
                    <li>Состоит из последовательности полей</li>
                    <li>Поля - именованые последовательности term`ов</li>
                    <li>Term - байты</li>
                </ul>
                <p>Term - единица поиска( aka слово в предложении/дата/ссылка/email и прочее)</p>
            </section>
            <section>
                <h4>Document</h4>
                <p>Все документы хранятся в сегментах</p>
            </section>
            <section>
                <h4>Segment</h4>
                <p>Сегмент состоит из нескольких файлов</p>
                <ul>
                    <li>.si - метаданные сегмента (сколько в нем документов, какие файлы используются)</li>
                    <li>.doc - соответствие терминов документам</li>
                    <li><a href="https://lucene.apache.org/core/7_2_1/">https://lucene.apache.org/core/7_2_1/</a></li>
                </ul>
                <p>Описание сегментов хранится в файле segments_N</p>
            </section>
            <section>
                <h3>segments_N</h3>
                <p>
                    Описание текущего коммита в индексе
                </p>
                <ul>
                    <li>N - поколение индекса</li>
                    <li>Хранит имя сегмента</li>
                </ul>
            </section>
            <section>
                Все файлы хранятся в виде блоков разного размера для лучшего сжатия
            </section>
            <section>
                <h3>Directory</h3>
                <p>
                    Абстракция над файловой системой предоставляющая методы доступа к ней
                </p>
            </section>
            <section>
                <h3>Index_Writer</h3>
                <p>
                    Модифицирует индекс
                </p>
                <ul>
                    <li>Может быть открыт только один (создает блокировку директории)</li>
                    <li>Хранит все модификации индекса в памяти до commit()/rollback()</li>
                    <li>При модификации индекса по необходимости вызывает слияние сегментов</li>
                </ul>
            </section>
            <section>
                <h2>Ускорение поиска</h2>
                <div>
                    Индекс разрастается с течением времени до гигабайтов и поиск может начать тормозить
                </div>
                <p>
                    Поиск мог занимать минуты (3 минуты в нашем опыте)
                </p>
            </section>
            <section>
                <img src="img/infinispan.png" style="border: none" />
                <h3>Infinispan Directory</h3>
            </section>
            <section>
                <h3>Infinispan Directory</h3>
                <div>
                    Мимикрирует под файловую систему<br> Строится на 3-х кешах:
                    <ol>
                        <li class="fragment">Metadata Cache - Описание данных </li>
                        <li class="fragment">Chunks Cache - Данные </li>
                        <li class="fragment">Locks Cache - Блокировки файлов</li>
                    </ol>
                </div>
            </section>
            <section>
                <h2>Metadata Cache</h2>
                <div>
                    Хранит в себе описание файла<br>
                    <ol>
                        <li>Имя файла</li>
                        <li>Размер буфера(чанка)</li>
                    </ol>
                </div>

            </section>
            <section>
                <h2>Metadata Cache</h2>
                <div>
                    <b>Требования</b><br>
                    <ul>
                        <li>Всё должно быть сохранено</li>
                        <li>maxEntries = -1</li>
                        <li>lifespan = -1</li>
                        <li>maxIdleTime = -1</li>
                    </ul><br>
                    <p class="fragment">Кроме этого сохраним всё в БД</p>
                </div>
            </section>
            <section>
                <h2>Chunk Cache</h2>
                <div>
                    Хранит сами файлы в виде чанков Сохранение в БД
                </div>
            </section>
            <section data-background="img/indexation.png" data-background-size="55%" data-background-transition="zoom">

            </section>
            <section data-background="img/loading.png" data-background-size="55%" data-background-transition="zoom">

            </section>
            <section data-transition="zoom">
                <h2>Profit!</h2>
                <p>
                    3 min -> 200ms
                </p>
            </section>
            <section data-background="img/unicorn.gif" data-background-transition="zoom"></section>
            <section>
                <h2>Первые проблемы</h2>
                <p>
                    ${Представьте, что здесь изображена потеря связи до БД}
                </p>
            </section>
            <section>
                <code data-trim class="java red-text">FileNotFoundException: Error loading metadata for index file ${filename}</code>
                <pre>
                    <code data-trim class="java" style="width: 150%">
Caused by: java.io.FileNotFoundException: Error loading ...
    at o.i.l.i.DirectoryImplementor.openInput(...)
    at o.i.l.i.DirectoryLuceneV4.openInput(...)
    at o.a.l.i.SegmentInfos.read(...)
    at o.a.l.i.StandardDirectoryReader$1.doBody(...)
    at o.a.l.i.SegmentInfos$FindSegmentsFile.run(...)
    at o.a.l.i.StandardDirectoryReader.open(...)
    at o.a.l.i.DirectoryReader.open(...)
                    </code>
                </pre>
                <p>
                    o.i.l.i - org.infinispan.lucene.impl <br> o.a.l.i - org.apache.lucene.index
                </p>
            </section>
            <section>
                <code data-trim class="java red-text">FileNotFoundException: Error loading metadata for index file ${filename}</code><br><br>
                <p class="fragment">Каждую секунду! Каждую секунду, Карл</p>
                <p class="fragment">Индексация не работает!</p>
                <p class="fragment">Поиск не работает!</p>
                <p class="fragment">Все пропало!</p>

            </section>
            <section>
                <h2>Будем резервировать индекс!</h2>
                <ul>
                    <li class="fragment">Файловая система: Сохранение всех файлов индекса в архиве рядом с рабочими файлами</li>
                    <li class="fragment">Infinispan: Копирование таблиц с индексом <b class="fragment red-text">SPOILER: просто так оно не работает</b></li>
                </ul>
            </section>
            <section data-background="img/unicorn.gif" data-background-transition="zoom"></section>
            <section>
                <p>Настало время разбираться с происходящим</p>
            </section>

            <section>
                <p>Вопросы на данный момент:</p>
                <ul>
                    <li class="fragment">Как проходит запись в БД?</li>
                    <li class="fragment">Почему при любой проблеме индекс ломается?</li>
                    <li class="fragment">Почему восстановление таблиц индекса не приводит к успеху?</li>
                </ul>
            </section>
            <section data-background-transition="zoom" data-background-size="50%">
                <p>Наше состояние на начало разбирательств</p>
                <img src="img/pepe.png" / style="border: none">

            </section>
            <section>
                <p>Как происходит запись в БД</p>
                <ul>
                    <li class="fragment">Каждый кеш - своя настройка синхронизации с БД</li>
                    <li class="fragment">На каждое изменение - новое соединие</li>
                    <li class="fragment">Неатомарно - проблема</li>
                </ul>
            </section>
            <section>
                <h4>Пишем за один раз</h4>
                <ul>
                    <li class="fragment">Metadata cache + Chunks cache = Index Cache</li>
                    <li class="fragment">Включаем транзакционность</li>
                    <li class="fragment">Собственный перехватчик команд, который сливает все изменения в рамках одной транзакции</li>
                    <li class="fragment">Custom LRU eviction for Index Cache (наткнулись на баг в Java <a href="https://bugs.openjdk.java.net/browse/JDK-8137184">JDK-8137184</a>)</li>
                </ul>
            </section>
            <section>
                <h3>Почему индекс сразу ломается?</h3>
                <div class="fragment">
                    <p>После предыдущих манипуляций получилось как-то так:</p>
                    <pre>
                        <code data-trim data-noescape class="java">
                            {
                                try(IndexWriter iw = getWriter()){
                                    ...
                                    txAction(() -> {
                                        iw.commit();
                                    });
                                }
                                ...
                            }
                        </code>
                    </pre>
                </div>
            </section>

            <section>
                <h3>Разберем что происходит</h3>
                <div>
                    <pre>
                        <code data-trim data-noescape class="java">
                            getWriter() {
                                ...
                                IndexWriterConfig indexConfig = new IndexWriterConfig()
                                //indexConfig.getPolicy().getClass()
                                //.equals(KeepOnlyLastCommitDeletionPolicy.class)
                                return new IndexWriter(directory, indexConfig)
                            } 
                        </code>
                    </pre>
                </div>
            </section>
            <section>
                <p>Политика по умолчанию</p>
                <pre>
                        <code data-trim data-noescape class="java">
                            public class KeepOnlyLastCommitDeletionPolicy 
                                   extends IndexDeletionPolicy {
                                ...
                                @Override
                                public void onInit(List&lt;? extends IndexCommit&gt; commits)
                                {
                                  onCommit(commits);
                                }
                                
                                @Override
                                public void onCommit(List&lt;? extends IndexCommit&gt; commits)
                                {
                                  int size = commits.size();
                                  for(int i=0;i&lt;size-1;i++) {
                                    commits.get(i).delete();
                                  }
                                }
                              }
                            </code>
                    </pre>
            </section>
            <section>
                <h3>Разберем что происходит</h3>
                <div>
                    <pre>
                        <code class="java" data-noescape>
                    txAction(() -> {
                        iw.commit();
                    });
                        </code>
                    </pre>
                    <div>
                        Все коммиты кроме последнего будут удалены
                    </div>
                </div>
            </section>
            <section>
                <div>
                    Транзакционность кеша
                </div>
                <pre>
                        <code class="java" data-noescape>
                    InfinispanTxSync
                    {
                        afterCompletion(int status){
                            ...
                            cache.prepare()
                            ...
                            cache.commit()
                        }
                    }
                        </code>
                    </pre>
                <div>
                    Что же может пойти не так? <b class="fragment red-text"> ВСЁ</b><br>
                    <span class="fragment">и мы об этом никогда не узнаем =(</span>
                </div>
            </section>
            <section>
                <p>Сюрприз в TransactionManager (Arjuna)</p>
                <pre>
                    <code data-trim class="java">
                            try
                            {
                                _theSynch.afterCompletion(s);
                
                                return true;
                            }
                            catch (Exception e)
                            {
                                jtaLogger.i18NLogger.warn_resources_arjunacore...
                
                                return false; // should not cause any affect!
                            }

                    </code>
                </pre>
            </section>
            <section>
                <h2>Что делать, товарищи?</h2>
                <ol>
                    <li class="fragment">Учиться хранить не только последний коммит</li>
                    <li class="fragment">Учиться следить за транзакциями в кеше</li>
                </ol>
            </section>
            <section>
                <h3>
                    Научились
                </h3>
                <pre>
                    <code class="java" data-trim>
                        {
                            indexCachemonitor.start();
                            runInTx(() -> {
                                try(IndexWriter iw = getWriter(${n-1 commit policy})){
                                    ...
                                    iw.commit();
                                }
                            }
                            if(indexCachemonitor.isTransactionFailed()){
                                rollBackComponent.rollBack()
                            }
                        }
                    </code>
                </pre>
            </section>
            <section>
                <h3>indexCachemonitor</h3>
                <pre>
                    <code style="font-size: 80%"class="java" data-trim>
                        public class IndexCacheMonitor
                        {
                            @Listener
                            private static final class IndexCacheListener
                            {                       
                                @TransactionCompleted
                                public void txComplete(
                                    TransactionCompletedEvent&lt?, ?&gt transactionEvent
                                ) 
                                { ... }
                            }
                    
                            public boolean isTransactionFailed() { ... }
                            
                            public void start() { indexCache.addListener(CACHE_LISTENER); }
                            public void stop() { indexCache.removeListener(CACHE_LISTENER); }
                        }
                    </code>
                </pre>
            </section>
            <section data-background="img/unicorn.gif" data-background-transition="zoom"></section>
            <section>
                <h3>Now what?</h3>
                <div class="fragment">
                    <p>Проблемы еще есть, и они постепенно решаются</p>
                    <img src="img/problems.png" height="400">
                </div>
            </section>
            <section>
                <h4>Итоги</h4>
                <div>
                    <table>
                        <tbody>
                            <tr>
                                <td style="width: 45%">Бесконечная индексация</td>
                                <td style="width: 10%">-></td>
                                <td style="width: 45%">Ограничить попытки</td>
                            </tr>
                            <tr class="fragment">
                                <td>Индексация файлов</td>
                                <td>-></td>
                                <td>В отдельном потоке</td>
                            </tr>
                            <tr class="fragment">
                                <td>Разрыв соединения с БД</td>
                                <td>-></td>
                                <td>Резервирование</td>
                            </tr>
                            <tr class="fragment">
                                <td>Неатомарная запись </td>
                                <td>-></td>
                                <td>Атомарная запись</td>
                            </tr>
                            <tr class="fragment">
                                <td>Тайны ТМ </td>
                                <td>-></td>
                                <td>Слежка за транзакциями</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            <section>
                <h3>Q & A</h3>
            </section>
        </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
        // Full list of configuration options available at:
        // https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize({
            controls: false,
            progress: true,
            history: true,
            center: true,
            slideNumber: true,

            transition: 'slide', // none/fade/slide/convex/concave/zoom

            // Optional reveal.js plugins
            dependencies: [{
                src: 'lib/js/classList.js',
                condition: function() {
                    return !document.body.classList;
                }
            }, {
                src: 'plugin/markdown/marked.js',
                condition: function() {
                    return !!document.querySelector('[data-markdown]');
                }
            }, {
                src: 'plugin/markdown/markdown.js',
                condition: function() {
                    return !!document.querySelector('[data-markdown]');
                }
            }, {
                src: 'plugin/highlight/highlight.js',
                async: true,
                condition: function() {
                    return !!document.querySelector('pre code');
                },
                callback: function() {
                    hljs.initHighlightingOnLoad();
                }
            }, {
                src: 'plugin/zoom-js/zoom.js',
                async: true
            }, {
                src: 'plugin/notes/notes.js',
                async: true
            }]
        });
    </script>

</body>

</html>